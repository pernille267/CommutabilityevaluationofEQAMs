---
title: "Commutability Evaluation Report"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: pdflatex
fontsize: 11pt
params:
  # From mod_file_upload
  cs_data: NA
  eq_data: NA
  diagnostics_cs: NA
  diagnostics_eq: NA
  diagnostics_both: NA
  
  # From mod_outlier_analysis
  outlier_results: NA
  outlier_params: NA
  
  # From mod_model_validation
  formal_assessment_results: NA
  assessment_plot: NA
  assessment_plot_type: NA
  
  # From mod_dins
  dins_params: NA
  
  # From mod_results
  ce_results: NA
  ce_plot: NA
---

```{r setup, include=FALSE}

# This chunk sets up the global options for the report.
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center',
  fig.pos = 'H'
)

# Load necessary libraries for rendering tables
library(knitr)
library(data.table)
library(kableExtra)
library(ggplot2)
library(glue)

# Local functions
smart_paste <- function(items, bold = FALSE) {
  # Apply formatting to each item first, if requested
  if (bold) {
    items <- paste0("**", items, "**")
  }
  
  n <- length(items)
  if (n == 0) return("")
  if (n == 1) return(items[1])
  if (n == 2) return(paste(items, collapse = " and "))
  
  # For 3 or more items, the separators are hard-coded and will not be bold
  initial_items <- paste(items[1:(n - 1)], collapse = ", ")
  return(paste0(initial_items, " and ", items[n]))
}


```

# Introduction

This report details the commutability evaluation of External Quality Assessment Materials (EQAMs) / Certified Reference Materials (CRMs) against clinical samples (CS). The analysis was performed using the `CommutabilityevaluationofEQAMs` Shiny application. All data, parameters, and results are documented below.

# Data Diagnostics

This section outlines the validation checks performed on your uploaded data. To ensure suitability for analysis, both the **clinical sample (CS)** and **external quality assessment material (EQAM)** files are subjected to four key tests.

For clarity, 'IVD-MD' refers to an in vitro diagnostic medical device.

1. **Mandatory ID Columns**: This check verifies the presence of the mandatory SampleID and ReplicateID columns. These columns must be named correctly, though the system can correct for minor typos. This check is fundamental; a failure here will halt any further validation.
2. **Numeric IVD-MD Measurements**: This ensures that all measurement values reported by the IVD-MDs are numeric or can be successfully converted into a numeric format.
3. **Number of Missing Values**: This multi-step test evaluates data completeness:
  * It assesses the overall fraction of missing values across the dataset.
  * It compares the proportion of missing values between different IVD-MDs. If one device has a disproportionately high number of missing entries, the system may attempt to repair the data by removing this IVD-MD before re-testing.
  * For CS data only, the dataset must contain a minimum of 20 valid samples after rows with missing values have been excluded. A dataset with fewer than 20 samples will automatically fail.
4. **Number of IVD-MDs**: This final check confirms that the dataset contains at least two valid IVD-MDs after excluding any devices that failed the two preceding checks.

Based on the performance in these four checks, your data is assigned a quality score ranging from 0 (poor) to 9 (excellent). This score is then translated into a colored badge, providing an immediate, at-a-glance indication of the overall data quality.

## Clinical Sample (CS) Data Diagnostics

```{r cs-diagnostics}

# Message to user
message_to_user <- NULL

# Checks if diagnostic data for clinical samples are available
if (isTRUE(is.list(params$diagnostics_cs))) {
  
  # Number of tests that passed
  num_tests_passed <- sum(unlist(params$diagnostics_cs$validity))
  
  # Display the validation test results
  validation_dt <- data.table(
    Test = c(
      "Mandatory ID Columns",
      "Numeric IVD-MD Measurements",
      "Number of Missing Values",
      "Number of IVD-MDs"),
    Status = c(
      ifelse(params$diagnostics_cs$validity$valid_mandatory_id_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_cs$validity$valid_numeric_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_cs$validity$valid_number_nas, "PASS", "FAIL"),
      ifelse(params$diagnostics_cs$validity$valid_number_remaining_numeric, "PASS", "FAIL")
    )
  )
  
  # Display text
  message_to_user <- paste0(
    "Your clinical sample data passed a total of ",
    num_tests_passed,
    " out of 4 validation tests. Based on these results, the data achieved a **quality score of ",
    params$diagnostics_cs$score,
    " out of 9** and earned a **",
    params$diagnostics_cs$badge,
    "** badge."
  )
  
  
  # Generate the table
  kbl(
    x = validation_dt,
    format = "latex",
    caption = "Clinical Sample Data Validation Tests",
    booktabs = TRUE,
    align = "lc",
    position = "H",
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    column_spec(
      column = 2,
      bold = TRUE,
      color = ifelse(validation_dt$Status == "PASS", "#28A745", "#dc3545")
    ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isTRUE(is.na(params$diagnostics_cs))) {
  message_to_user <- paste0(
   "Diagnostics for clinical sample could not be generated. ",
   "Did you upload valid clinical sample data in the ",
   "**Upload Data** Module of the application?"
  )
}

```

`r message_to_user`

## EQA Material (EQAM) Data Diagnostics

```{r eq-diagnostics}

# Message to user
message_to_user <- NULL

if (isTRUE(is.list(params$diagnostics_eq))) {
  
  # Number of tests that passed
  num_tests_passed <- sum(unlist(params$diagnostics_eq$validity))
  
  # Display text
  message_to_user <- paste0(
    "Your external quality assessment data passed a total of ",
    num_tests_passed,
    " out of 4 validation tests. Based on these results, the data achieved a **quality score of ",
    params$diagnostics_eq$score,
    " out of 9** and earned a **",
    params$diagnostics_eq$badge,
    "** badge."
  )
  
  # Display the validation test results
  validation_dt <- data.table(
    Test = c(
      "Mandatory ID Columns",
      "Numeric IVD-MD Measurements",
      "Number of Missing Values",
      "Number of IVD-MDs"
    ),
    Status = c(
      ifelse(params$diagnostics_eq$validity$valid_mandatory_id_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_eq$validity$valid_numeric_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_eq$validity$valid_number_nas, "PASS", "FAIL"),
      ifelse(params$diagnostics_eq$validity$valid_number_remaining_numeric, "PASS", "FAIL")
    )
  )
  
  # Generate the table
  kbl(
    x = validation_dt,
    format = "latex",
    caption = "External Quality Assessment Material Data Validation Tests",
    booktabs = TRUE,
    align = "lc",
    position = "H",
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    column_spec(
      column = 2,
      bold = TRUE,
      color = ifelse(validation_dt$Status == "PASS", "#28A745", "#dc3545")
    ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
  
}

if (isTRUE(is.na(params$diagnostics_eq))) {
  message_to_user <- paste0(
   "Diagnostics for external quality assessment material data could not be generated. ",
   "Did you upload valid external quality assessment material data in the ",
   "**Upload Data** Module of the application?"
  )
}


```

`r message_to_user`

## Structural Agreement Between Datasets

```{r both-diagnostics}

# Message to user
message_to_user <- NULL

if (isTRUE(is.list(params$diagnostics_both))) {
  
  # Make agreement data.table
  agreement_dt <- data.table(
    Test = c(
      "Equal IVD-MD Names",
      "Equal IVD-MD Column Order"
    ),
    Status = c(
      ifelse(params$diagnostics_both$equal_names, "PASS", "FAIL"),
      ifelse(params$diagnostics_both$equal_order, "PASS", "FAIL")
    )
  )
  
  # Generate the table
  kbl(
    x = agreement_dt,
    format = "latex",
    caption = "Structural Agreement Tests",
    booktabs = TRUE,
    align = "lc",
    position = "H",
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    column_spec(
      column = 2,
      bold = TRUE,
      color = ifelse(validation_dt$Status == "PASS", "#28A745", "#dc3545")
    ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isTRUE(is.na(params$diagnostics_both))) {
  message_to_user <- paste0(
    "Diagnostics for structural agreement between CS data and ",
    "EQAM data could not be generated. ",
    "You have either not uploaded necessary data or the uploaded data are not valid."
  )
}

```

`r message_to_user`

# Analysis Parameters

```{r dins-parameters}

# Message to user
message_to_user <- NULL

if (isTRUE(is.list(params$dins_params))) {
  
  selected_transformation <- switch(params$dins_params$transformation,
                                    "identity" = "None",
                                    "ln" = "Natural Logarithm",
                                    "boxcox" = "Box-Cox",
                                    "None"
  )
  
  selected_model <- switch(params$dins_params$pi_method,
                           "fg" = "Deming",
                           "ss" = "Smoothing Spline",
                           "ssw" = "Weighted Smoothing Spline",
                           "Unknown"
  )
  
  message_to_user <- paste0(
    "This section outlines the difference in nonselectivity parameters ",
    "selected to perform the commutability evaluation. ",
    ifelse(
      selected_transformation == "None",
      "You have selected not to transform the data.",
      paste0(
        "You have selected to transform the data using a ",
        params$dins_params$transformation,
        " transformation."
      )
    ),
    ifelse(
      selected_model == "Deming",
      paste0(
        "You have implicitly selected using the Ordinary Least Squares regression model ",
        "to estimate $\\zeta$, and to use Deming regression to estimate the ",
        "prediction intervals."
      ),
      paste0(
        " The ",
        selected_model,
        " Regression model is selected to estimate $\\zeta$ and the prediction intervals."
      )
    ),
    " A value of $M(\\%)$",
    sprintf(
      "$= %s$",
      paste0(params$dins_params$M * 100, "\\%")
    ),
    " is used as the maximum tolerable magnitude of differences in nonselectivity. ",
    "Based on this value of $M(\\%)$ and on your data, the critical value ",
    "for acceptable differences in nonselectivity is then ",
    sprintf(
      "$\\zeta_{\\mathrm{upper}} \\approx %s$",
      format(params$dins_params$zeta_upper, nsmall = 2L, digits = 2L)
    ),
    "."
  )
  
  
  params_dt <- data.table(
    Parameter = c(
      "Data Transformation",
      "Prediction Interval Method",
      "Differences in Nonselectivity Tolerance $M(\\%)$",
      "Determined $\\zeta_{\\mathrm{upper}}$"
    ),
    Value = c(
      selected_transformation,
      selected_model,
      paste0(params$dins_params$M * 100, "\\%"),
      format(params$dins_params$zeta_upper, nsmall = 2L, digits = 2L)
    )
  )
  kbl(
    x = params_dt,
    format = "latex",
    caption = "Differences in Nonselectivity Parameters",
    booktabs = TRUE,
    align = "lc",
    escape = FALSE,
    position = "H"
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isTRUE(is.na(params$dins_params))) {
  message_to_user <- paste0(
    "This section would outline the difference in nonselectivity parameters ",
    "selected to perform the commutability evaluation. ",
    "However, these parameters could not be displayed. ",
    "You have either not uploaded necessary data or the uploaded data ",
    "are not valid."
  )
}

```

`r message_to_user`

# Outlier Analysis


```{r outlier-analysis-params}

message_to_user <- NULL

if (isTRUE(inherits(params$outlier_results, "data.table"))) {

  test_name <- ifelse(
    params$outlier_params$outlier_test == "burnett",
    "Between Samples (Burnett's Criterion)", 
    "Within Samples (Studentized Range Q)"
  )
  
  message_to_user <- paste0(
    "This section displays the selected parameters and corresponding ",
    "results of the outlier analysis performed on the clinical sample data. ",
    "You have selected to test for outliers ",
    ifelse(
      params$outlier_params$outlier_test == "burnett",
      paste0(
        "between samples using Burnett's test with a type I error of ",
        paste0(
          "$",
          format(
            x = 100 - params$outlier_params$outlier_test_conf_level * 100,
            nsmall = 1,
            digits = 1
          ),
          "\\%$"
        ),
        ". ",
        "The standardized residuals based on a polynomial model ",
        "is selected as variable. "
      ),
      paste0(
        "within samples using the studentized range (Q) test with a type I error of ",
        paste0(
          "$",
          format(
            x = 100 - params$outlier_params$outlier_test_conf_level * 100,
            nsmall = 1,
            digits = 1
          ),
          "\\%$"
        ),
      ". ",
      "The raw clinical sample measurements are used as the selected variable."
      )
    )
  )
  
  # Outlier Parameter Table
  outlier_params_dt <- data.table(Parameter = c("Outlier Test", "Confidence Level"),
                                  Value = c(
                                    test_name,
                                    paste0(
                                      "$",
                                      format(
                                        x = params$outlier_params$outlier_test_conf_level * 100,
                                        nsmall = 1,
                                        digits = 1
                                      ),
                                      "\\%$"
                                    )
                                  ))
  
  # Explicitly print the parameters table
  kbl(
      x = outlier_params_dt,
      format = "latex",
      caption = "Outlier Analysis Parameters",
      booktabs = TRUE,
      label = "outlier-analysis-params",
      align = "lc",
      escape = FALSE,
      position = "H"
    ) |>
      row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isFALSE(inherits(params$outlier_results, "data.table"))) {
  message_to_user <- paste0(
    "This section would display the selected parameters and corresponding ",
    "results of the outlier analysis performed on the clinical sample data. ",
    "However, these were not chosen to be or could not be generated. "
  ) 
}

```

`r message_to_user`

```{r outlier-analysis-results}

if (isTRUE(inherits(params$outlier_results, "data.table"))) {

  aligning <- ifelse(
    params$outlier_params$outlier_test == "burnett",
    "lcc", 
    paste0("l", paste0(rep("c", ncol(params$outlier_results)), collapse = ""))
  )
  
  test_caption <- ifelse(
    params$outlier_params$outlier_test == "burnett",
    "Outlier Analysis Between Samples Results", 
    "Outlier Analysis Within Samples Results"
  )
  
  outlier_dt <- params$outlier_results
  
  kbl(
    x = outlier_dt,
    format = "latex",
    caption = test_caption,
    booktabs = TRUE,
    label = "outlier-analysis-results",
    align = aligning,
    position = "H"
  ) |>
    row_spec(
    row = 0,
    bold = TRUE,
    color = "white",
    background = "#605ca8"
  ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
  
}

```

# Model Validation

```{r model-validation}

message_to_user <- NULL
mv_table_exists <- isTRUE(inherits(params$formal_assessment_results, "data.table"))
mv_plot_exists <- isTRUE(inherits(params$assessment_plot, "ggplot"))

if (mv_table_exists && mv_plot_exists) {
  
  plot_name <- switch(
    params$assessment_plot_type,
    "residual_plot" = "residual versus fitted",
    "residual_histogram" = "histogram of residuals",
    "qq_plot" = "quantile-quantile normal",
    "sd_vs_concentration" = "standard deviation versus concentration",
    "cv_vs_concentration" = "coefficient of variation versus concentration",
    "unknown"
  )
    
  plot_purpose <- switch(
    params$assessment_plot_type,
    "residual_plot" = "validate model linearity and variance homogeneity",
    "residual_histogram" = "validate normality",
    "qq_plot" = "validate normality",
    "sd_vs_concentration" = "validate variance homogeneity",
    "cv_vs_concentration" = "validate coefficient of variation homogeneity",
    "something"
  )
  
  message_to_user <- paste0(
    "This section presents the results from the ",
    "formal and visual model validation tests. ",
    "Concerning the formal validation tests, ",
    "Both normality and variance homogeneity tests ",
    "are performed on the data (transformed data if selected) ",
    "using a family-wise type I error of $5\\%$. ",
    "A hypothesis test is performed on each IVD-MD pair. ",
    "Concerning the visual validation tests, a ",
    plot_name,
    " plot is selected to test for ",
    plot_purpose,
    "."
  )
}

if (mv_table_exists && (!mv_plot_exists)) {
  message_to_user <- paste0(
    "This section presents the results from the ",
    "formal validation tests. ",
    "Both normality and variance homogeneity tests ",
    "are performed on the data (transformed data if selected) ",
    "using a family-wise type I error of $5\\%$. ",
    "A test is performed on each IVD-MD pair. "
  )
}

if ((!mv_table_exists) && mv_plot_exists) {
  
  plot_name <- switch(
    params$assessment_plot_type,
    "residual_plot" = "residual versus fitted",
    "residual_histogram" = "histogram of residuals",
    "qq_plot" = "quantile-quantile normal",
    "sd_vs_concentration" = "standard deviation versus concentration",
    "cv_vs_concentration" = "coefficient of variation versus concentration",
    "unknown"
  )
    
  plot_purpose <- switch(
    params$assessment_plot_type,
    "residual_plot" = "validate model linearity and variance homogeneity",
    "residual_histogram" = "validate normality",
    "qq_plot" = "validate normality",
    "sd_vs_concentration" = "validate variance homogeneity",
    "cv_vs_concentration" = "validate coefficient of variation homogeneity",
    "something"
  )
  
  message_to_user <- paste0(
    "This section presents the results from the ",
    "visual model validation tests. ",
    "A ",
    plot_name,
    " plot is selected to test for ",
    plot_purpose,
    "."
  )
}

if ((!mv_table_exists) && (!mv_plot_exists)) {
  message_to_user <- paste0(
    "This section would present the results from the ",
    "model validation tests. ",
    "However, neither the formal or visual validation tests ",
    "are generated. This is possible by design by you, or caused by ",
    "invalid uploaded data."
    
  )
}

```

`r message_to_user`

## Formal Model Assessment

```{r formal-assessment}

if (mv_table_exists) {
  
  kbl(
    x = params$formal_assessment_results,
    format = "latex",
    caption = "Formal Model Assessment Test Results",
    align = "lccccc",
    booktabs = TRUE,
    position = "H",
    linesep = ""
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8"
    ) |>
    kable_styling(
      latex_options = c("scale_down", "striped")
    )
}


```

## Visual Model Assessment Plot

```{r setup-vma-plot-dims, include=FALSE}

# This chunk calculates the optimal plot dimensions before the plot chunk is run.
if (mv_plot_exists) {
  n_panels <- nlevels(ggplot_build(params$assessment_plot)$data[[1]]$PANEL)
  
  # Determine layout
  n_cols <- ceiling(sqrt(n_panels))
  n_rows <- ceiling(n_panels / n_cols)
  
  # Calculate dimensions in inches (LaTeX default)
  plot_width <- 2 + (n_cols * 2.5)
  plot_height <- 1.5 + (n_rows * 2.5)
  
  # Clamp to reasonable min/max values
  plot_width <- max(6, min(22, plot_width))
  plot_height <- max(4, min(20, plot_height))
  
} else {
  plot_width <- 12
  plot_height <- 10
}
```


```{r visual-assessment-plot, fig.width = plot_width, fig.height = plot_height, out.width = "100%", fig.cap = "Model Assessment Plot"}

if (mv_plot_exists) {
  plot(params$assessment_plot)
}

```

# Commutability Evaluation Results

```{r ce-results-introduction}

message_to_user <- NULL
ce_table_exists <- isTRUE(is.list(params$ce_results)) && isTRUE(inherits(params$ce_results$merged_ce_data, "data.table"))
ce_plot_exists <- isTRUE(inherits(params$ce_plot, "ggplot"))

if (ce_table_exists || ce_plot_exists) {
  message_to_user <- paste0(
    "This section displays commutability evaluation results, ",
    "based on the data and the parameters (both provided and internally determined). "
  )
}

if ((!ce_table_exists) && (!ce_plot_exists)) {
  message_to_user <- paste0(
    "This section would display the commutability evaluation results, ",
    "based on the data and the parameters (both provided and internally determined). ",
    "Nevertheless, neither tables or plots are generated. ",
    "This may be design by you or a result of invalid uploaded data."
  )
}


```

`r message_to_user`

## Results Table

```{r ce-results-table-1}

message_to_user <- NULL

if (ce_table_exists) {
  
  # Extract ce_data
  ce_results_dt <- params$ce_results$merged_ce_data
  
  # Reformat columns
  ce_results_dt$Zeta <- paste0(
    format(
      x = ce_results_dt$zeta,
      nsmall = 2,
      digits = 2
    ),
    " (",
    format(
      x = ce_results_dt$zeta_ci_lwr,
      nsmall = 2,
      digits = 2
    ),
    " - ",
    format(
      x = ce_results_dt$zeta_ci_upr,
      nsmall = 2,
      digits = 2
    ),
    ")"
  )
  
  ce_results_dt$Zeta_upr <- format(
    x = ce_results_dt$zeta_upper,
    nsmall = 2,
    digits = 2
  )
  
  ce_results_dt$Measurements <- paste0(
    "(",
    format(
      x = ce_results_dt$MP_B,
      nsmall = 2,
      digits = 2
    ),
    ", ",
    format(
      x = ce_results_dt$MP_A,
      nsmall = 2,
      digits = 2
    ),
    ")"
  )
  
  ce_results_dt$Pred <- paste0(
    format(
      x = ce_results_dt$pi_lwr,
      nsmall = 2L,
      digits = 2L
    ),
    " - ",
    format(
      x = ce_results_dt$pi_upr,
      nsmall = 2L,
      digits = 2L
    )
  )
  
  ce_results_dt$Conclusion <- ifelse(
    ce_results_dt$pi_inside == 1L & ce_results_dt$dins_conclusion == 0L,
    "Commutable",
    ifelse(
      ce_results_dt$pi_inside == 0L & ce_results_dt$dins_conclusion == 0L,
      "Noncommutable",
      "Excessive DINS"
    )
  )
  
  ce_results_dt$Strength <- ifelse(
    ce_results_dt$pi_inside == 1L & ce_results_dt$dins_conclusion == 0L,
    paste0(
      "$",
      format(ce_results_dt$pi_inside * 100, nsmall = 1, digits = 1),
      " \\%$"
    ),
    ifelse(
      ce_results_dt$pi_inside == 0L & ce_results_dt$dins_conclusion == 0L,
      paste0(
        "$",
        format((1 - ce_results_dt$pi_inside) * 100, nsmall = 1, digits = 1),
        " \\%$"
      ),
      "."
    )
  )
  
  ce_results_display_dt <- subset(
    x = ce_results_dt,
    select = c(
      "SampleID",
      "Zeta",
      "Zeta_upr",
      "Measurements",
      "Pred",
      "Conclusion",
      "Strength"
    )
  )
  
  list_of_SampleID <- unique(ce_results_dt$SampleID)
  list_of_comparison <- unique(ce_results_dt$comparison)
  list_of_dins_conclusion <- tapply(
    X = ce_results_dt$dins_conclusion,
    INDEX = ce_results_dt$comparison,
    FUN = function(x) {
      x[1]
    },
    simplify = TRUE
  )

  # =================================================================
  # REFACTORED MESSAGE GENERATION
  # =================================================================
  
  # --- Add this line to create a bolded version of the SampleIDs ---
  bold_samples <- paste0("**", list_of_SampleID, "**")
    
  ### PART 1: Generate the list of evaluated materials ###
  
  n_samples <- length(list_of_SampleID)
  
  if (n_samples >= 10) {
    # Special case for 10+ samples
    first_part <- paste(paste0("**", list_of_SampleID[1:4], "**"), collapse = ", ")
    last_part <- smart_paste(list_of_SampleID[(n_samples - 3):n_samples], bold = TRUE)
    sample_list_text <- glue(
      "{first_part}, ..., {last_part}. Because there are ten or more",
      "evaluated materials, the list is abbreviated."
    )
  } else {
    # Standard case for < 10 samples
    sample_list_text <- glue("{smart_paste(list_of_SampleID, bold = TRUE)}.")
  }
  
  message_part1 <- glue(
    "The table below shows the detailed numerical results of the commutability ",
    "evaluation results of these {n_samples} evaluated materials: {sample_list_text}"
  )
  
  
  ### PART 2: Report on DINS conclusions ###
  
  # Pre-calculate key metrics to simplify the code
  n_total <- length(list_of_dins_conclusion)
  n_excessive <- sum(list_of_dins_conclusion == 1)
  n_acceptable <- n_total - n_excessive
  prop_excessive <- n_excessive / n_total
  
  # Get the names of the comparison groups
  excessive_comparisons <- list_of_comparison[list_of_dins_conclusion == 1]
  acceptable_comparisons <- list_of_comparison[list_of_dins_conclusion == 0]
  
  # Use a clear if/else if/else block for the logic
  if (prop_excessive == 0) {
    # Case 1: All are acceptable
    message_part2 <- glue(
      "Concerning differences in nonselectivity, all IVD-MD pairs were deemed ",
      "to have an acceptable magnitude of differences in nonselectivity. ",
      "This means that all {n_total} IVD-MD pairs are eligible for commutability ",
      "evaluation of the evaluated materials. "
    )
  } 
  else if (prop_excessive == 1) {
    # Case 2: All are excessive
    message_part2 <- glue(
      "Concerning differences in nonselectivity, all {n_total} IVD-MD pairs were ",
      "deemed to have an excessive magnitude of differences in nonselectivity. ",
      "This means that none of the IVD-MD pairs are eligible for commutability ",
      "evaluation of the evaluated materials. "
    )
  } 
  else if (prop_excessive <= 0.25) {
    # Case 3: A minority are excessive (<=25%)
    message_part2 <- glue(
    "Concerning differences in nonselectivity, only {n_excessive} out of a total ",
    "of {n_total} IVD-MD pairs were deemed to have excessive differences ",
    "in nonselectivity. "
    )
    if (n_excessive <= 5) {
      list_text <- smart_paste(excessive_comparisons)
      message_part2 <- glue("{message_part2} These IVD-MDs were: {list_text}.")
    }
  } 
  else if (prop_excessive >= 0.75) {
    # Case 4: A majority are excessive (>=75%)
    message_part2 <- glue(
      "Concerning differences in nonselectivity, only {n_acceptable} out of a ",
      "total of {n_total} IVD-MD pairs were deemed to have acceptable ",
      "differences in nonselectivity. "
    )
    if (n_acceptable <= 5) {
      list_text <- smart_paste(acceptable_comparisons)
      message_part2 <- glue("{message_part2} These IVD-MDs were: {list_text}. ")
    }
  } else {
    # Case 5: The "middle" cases (between 25% and 75%)
    if (prop_excessive >= 0.5) { # 50% to <75% are excessive
      message_part2 <- glue(
        "Concerning differences in nonselectivity, most IVD-MD ",
        "pairs ({n_excessive} out of {n_total}) were deemed to have an ",
        "excessive magnitude of differences in nonselectivity. ",
        "None of the IVD-MD pairs with excessive DINS are eligible for ",
        "commutability evaluation of the evaluated materials. "
      )
    }else { # >25% to <50% are excessive (i.e., most are acceptable)
      message_part2 <- glue(
        "Concerning differences in nonselectivity, most IVD-MD ",
        "pairs ({n_acceptable} out of {n_total}) were deemed to have an ",
        "acceptable magnitude of differences in nonselectivity. ",
        "All those IVD-MD pairs with acceptable DINS are eligible for ",
        "commutability evaluation of the evaluated materials. "
      )
    }
  }
  
  ### PART 3: Combine and display the final message ###
  message_to_user <- paste(message_part1, message_part2)
    
  # Render Table
  kbl(
    x = ce_results_display_dt,
    format = "latex",
    col.names = c(
      "ID",
      "$\\hat{\\zeta}$",
      "$\\hat{\\zeta}_{\\mathrm{crit}}$",
      "(x, y)",
      "PI",
      "Conclusion",
      "Strength"
    ),
    align = "lcccccc",
    booktabs = TRUE,
    caption = "Commutability Evaluation Results",
    longtable = TRUE,
    position = "H",
    escape = FALSE
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8"
    ) |>
    pack_rows(
      index = table(ce_results_dt$comparison),
      bold = TRUE
    ) |>
    column_spec(
      column = 6,
      bold = TRUE,
      color = ifelse(
        ce_results_dt$Conclusion == "Commutable",
        "#28A745",
        ifelse(
          ce_results_dt$Conclusion == "Noncommutable",
          "#dc3545",
          "orange"
        )
      )
    ) |>
    kable_styling(
      latex_options = c(
        "striped",
        "repeat_header"
      )
    )
}

```

`r message_to_user`

```{r ce-results-table-2}

if (ce_table_exists) {
  
  # Extract ce_data
  ce_results_dt <- params$ce_results$merged_ce_data
  
  # Generate commutability evaluation summary
  ce_results_summary_dt <- ce_results_dt[, list(
    "commutable" = paste0(
      sum(pi_inside == 1 & dins_conclusion == 0),
          " / ",
          length(dins_conclusion)
    ),
    "noncommutable" = paste0(
      sum(pi_inside == 0 & dins_conclusion == 0),
      " / ",
      length(dins_conclusion)
    ),
    "inside_pi" = paste0(
      sum(pi_inside == 1 & dins_conclusion == 1),
      " / ",
      length(dins_conclusion)
    ),
    "outside_pi" = paste0(
      sum(pi_inside == 0 & dins_conclusion == 1),
      " / ",
      length(dins_conclusion)
    )
  ), by = SampleID]
  
  # Render Table
  kbl(
    x = ce_results_summary_dt,
    format = "latex",
    col.names = c(
      "ID of Evaluated Material",
      "Commutable",
      "Noncommutable",
      "Inside PI",
      "Outside PI"
    ),
    align = "lcccc",
    booktabs = TRUE,
    caption = "Commutability Evaluation Results Summarized by Evaluated Materials",
    position = "H",
    escape = FALSE
  ) |>
    add_header_above(
      header = c(" " = 1, "Acceptable DINS" = 2, "Excessive DINS" = 2),
      bold = TRUE
    ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8"
    ) |>
    kable_styling(
      latex_options = c(
        "scale_down",
        "striped"
      )
    )
}

```

## Results Plot

The plot below provides a graphical representation of the commutability evaluation.

```{r setup-ce-plot-dims, include=FALSE}

# This chunk calculates the optimal plot dimensions before the plot chunk is run.
if (ce_plot_exists) {
  n_panels <- nlevels(ggplot_build(params$ce_plot)$data[[1]]$PANEL)
  
  # Determine layout
  n_cols <- ceiling(sqrt(n_panels))
  n_rows <- ceiling(n_panels / n_cols)
  
  # Calculate dimensions in inches (LaTeX default)
  plot_width <- 2 + (n_cols * 2.5)
  plot_height <- 1.5 + (n_rows * 2.5)
  
  # Clamp to reasonable min/max values
  plot_width <- max(6, min(22, plot_width))
  plot_height <- max(4, min(20, plot_height))
  
} else {
  plot_width <- 12
  plot_height <- 10
}
```

```{r ce-results-plot, fig.width = plot_width, fig.height = plot_height, out.width = "100%", fig.cap = "Commutability Evaluation Plot"}

if (ce_plot_exists) {
  plot(params$ce_plot)
}


```


