---
title: "Commutability Evaluation Report"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: pdflatex
fontsize: 11pt
params:
  # From mod_file_upload
  cs_data: NA
  eq_data: NA
  diagnostics_cs: NA
  diagnostics_eq: NA
  diagnostics_both: NA
  
  # From mod_outlier_analysis
  outlier_results: NA
  outlier_params: NA
  
  # From mod_model_validation
  formal_assessment_results: NA
  assessment_plot: NA
  
  # From mod_dins
  dins_params: NA
  
  # From mod_results
  ce_results: NA
  ce_plot: NA
---

```{r setup, include=FALSE}

# This chunk sets up the global options for the report.
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.pos = 'H')

# Load necessary libraries for rendering tables
library(knitr)
library(data.table)
library(kableExtra)
library(ggplot2)

```

\maketitle

\tableofcontents

\newpage

# Introduction

This report details the commutability evaluation of External Quality Assessment Materials (EQAMs) / Certified Reference Materials (CRMs) against clinical samples (CS). The analysis was performed using the `CommutabilityevaluationofEQAMs` Shiny application. All data, parameters, and results are documented below.

\newpage

# Data Diagnostics

This section summarizes the initial diagnostic checks performed on the uploaded data files. 

## Clinical Sample (CS) Data Diagnostics

```{r cs-diagnostics}

# Message to user
message_to_user <- NULL

# Checks if diagnostic data for clinical samples are available
if (isTRUE(is.list(params$diagnostics_cs))) {
  
  # Display the quality badge and score
  cat(paste("**Overall Quality Badge:**", params$diagnostics_cs$badge, "\n\n"))
  cat(paste("**Quality Score:**", params$diagnostics_cs$score, "/ 9\n\n"))
  
  # Display the validation test results
  validation_dt <- data.table(
    Test = c(
      "Mandatory ID Columns",
      "Numeric IVD-MD Measurements",
      "Acceptable Number of Missing Values",
      "Sufficient Number of IVD-MDs"),
    Status = c(
      ifelse(params$diagnostics_cs$validity$valid_mandatory_id_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_cs$validity$valid_numeric_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_cs$validity$valid_number_nas, "PASS", "FAIL"),
      ifelse(params$diagnostics_cs$validity$valid_number_remaining_numeric, "PASS", "FAIL")
    )
  )
  
  # Generate the table
  kbl(
    x = validation_dt,
    format = "latex",
    caption = "Clinical Sample Data Validation Tests",
    booktabs = TRUE,
    align = "lc"
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    column_spec(
      column = 2,
      bold = TRUE,
      color = ifelse(validation_dt$Status == "PASS", "#28A745", "#dc3545")
    ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isTRUE(is.na(params$diagnostics_cs))) {
  message_to_user <- "Diagnostics for clinical sample data could not be generated."
}


```

`r message_to_user`

## EQA Material (EQAM) Data Diagnostics

```{r eq-diagnostics}

# Message to user
message_to_user <- NULL

if (isTRUE(is.list(params$diagnostics_eq))) {
  # Display the quality badge and score
  cat(paste("**Overall Quality Badge:**", params$diagnostics_eq$badge, "\n\n"))
  cat(paste("**Quality Score:**", params$diagnostics_eq$score, "/ 9\n\n"))
  
  # Display the validation test results
  validation_dt <- data.table(
    Test = c(
      "Mandatory ID Columns",
      "Numeric IVD-MD Measurements",
      "Acceptable Missing Values",
      "Sufficient IVD-MDs"
    ),
    Status = c(
      ifelse(params$diagnostics_eq$validity$valid_mandatory_id_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_eq$validity$valid_numeric_columns, "PASS", "FAIL"),
      ifelse(params$diagnostics_eq$validity$valid_number_nas, "PASS", "FAIL"),
      ifelse(params$diagnostics_eq$validity$valid_number_remaining_numeric, "PASS", "FAIL")
    )
  )
  
  # Generate the table
  kbl(
    x = validation_dt,
    format = "latex",
    caption = "External Quality Assessment Material Data Validation Tests",
    booktabs = TRUE,
    align = "lc"
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    column_spec(
      column = 2,
      bold = TRUE,
      color = ifelse(validation_dt$Status == "PASS", "#28A745", "#dc3545")
    ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
  
}

if (isTRUE(is.na(params$diagnostics_eq))) {
  message_to_user <- "Diagnostics for external quality assessment data could not be generated."
}


```

`r message_to_user`

## Structural Agreement Between Datasets

```{r both-diagnostics}

# Message to user
message_to_user <- NULL

if (isTRUE(is.list(params$diagnostics_both))) {
  agreement_dt <- data.table(
    Test = c(
      "Equal IVD-MD Names",
      "Equal IVD-MD Column Order"
    ),
    Status = c(
      ifelse(params$diagnostics_both$equal_names, "PASS", "FAIL"),
      ifelse(params$diagnostics_both$equal_order, "PASS", "FAIL")
    )
  )
  
  kbl(
    x = agreement_dt,
    format = "latex",
    caption = "Structural Agreement Tests",
    booktabs = TRUE,
    align = "lc"
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    column_spec(
      column = 2,
      bold = TRUE,
      color = ifelse(validation_dt$Status == "PASS", "#28A745", "#dc3545")
    ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isTRUE(is.list(params$diagnostics_both))) {
  message_to_user <- NULL
}

```

`r message_to_user`

\newpage

# Analysis Parameters

This section outlines the parameters selected by the user to perform the commutability evaluation.

```{r dins-parameters}

# Message to user
message_to_user <- NULL

if (isTRUE(is.list(params$dins_params))) {
  params_dt <- data.table(
    Parameter = c(
      "Data Transformation",
      "Prediction Interval Method",
      "Differences in Nonselectivity Tolerance $M(\\%)$",
      "Recommended $\\zeta_{\\mathrm{upper}}$"
    ),
    Value = c(
      params$dins_params$transformation,
      params$dins_params$pi_method,
      paste0(params$dins_params$M * 100, "\\%"),
      round(params$dins_params$zeta_upper, 3)
    )
  )
  kbl(
    x = params_dt,
    format = "latex",
    caption = "Core Analysis Parameters",
    booktabs = TRUE,
    align = "lc",
    escape = FALSE
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

if (isTRUE(is.na(params$dins_params))) {
  message_to_user <- "Could not generate differences in nonselectivity (DINS) parameters"
}

```

`r message_to_user`

\newpage

# Outlier Analysis

This section displays the results of the outlier analysis performed on the clinical sample data.

```{r outlier-analysis-params}

if (isTRUE(inherits(params$outlier_results, "data.table"))) {

  test_name <- ifelse(
    params$outlier_params$outlier_test == "burnett",
    "Between Samples (Burnett's Criterion)", 
    "Within Samples (Studentized Range Q)"
  )
  
  # Outlier Parameter Table
  outlier_params_dt <- data.table(Parameter = c("Outlier Test", "Confidence Level"),
                                  Value = c(
                                    test_name,
                                    paste0(
                                      "$",
                                      format(
                                        x = params$outlier_params$outlier_test_conf_level * 100,
                                        nsmall = 1,
                                        digits = 1
                                      ),
                                      "\\%$"
                                    )
                                  ))
  
  # Explicitly print the parameters table
  kbl(
      x = outlier_params_dt,
      format = "latex",
      caption = "Outlier Analysis Parameters",
      booktabs = TRUE,
      label = "outlier-analysis-params",
      align = "lc",
      escape = FALSE
    ) |>
      row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8") |>
    kable_styling(latex_options = c("scale_down", "striped"))
}

```


```{r outlier-analysis-results}

message_to_user <- NULL

if (isTRUE(inherits(params$outlier_results, "data.table"))) {

  aligning <- ifelse(
    params$outlier_params$outlier_test == "burnett",
    "lcc", 
    paste0("l", paste0(rep("c", ncol(params$outlier_results)), collapse = ""))
  )
  
  test_caption <- ifelse(
    params$outlier_params$outlier_test == "burnett",
    "Outlier Analysis Between Samples Results", 
    "Outlier Analysis Within Samples Results"
  )
  
  outlier_dt <- params$outlier_results
  
  kbl(
    x = outlier_dt,
    format = "latex",
    caption = test_caption,
    booktabs = TRUE,
    label = "outlier-analysis-results",
    align = aligning
  ) |>
    row_spec(
    row = 0,
    bold = TRUE,
    color = "white",
    background = "#605ca8"
  ) |>
    kable_styling(latex_options = c("scale_down", "striped"))
  
}

if (isFALSE(inherits(params$outlier_results, "data.table"))) {
  message_to_user <- "Outlier analysis results were not generated."
}

```

`r message_to_user`

\newpage

# Model Validation

This section presents the results from the formal and visual model validation tests.

## Formal Model Assessment

```{r formal-assessment}

if (isTRUE(inherits(params$formal_assessment_results, "data.table"))) {
  
  kbl(
    x = params$formal_assessment_results,
    format = "latex",
    caption = "Formal Model Assessment Test Results",
    align = "lccccc",
    booktabs = TRUE,
    position = "H",
    linesep = ""
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8"
    ) |>
    kable_styling(
      latex_options = c("scale_down", "striped")
    )
}


```

## Visual Model Assessment Plot


```{r visual-assessment-plot, fig.width = 8, fig.height = 8, out.width = "80%", fig.cap = "Model Assessment Plot"}

if (isTRUE(inherits(params$assessment_plot, "ggplot"))) {
  plot(params$assessment_plot)
}


# CORRECTED: Use include_graphics with the file path
#if (isTRUE(is.character(params$assessment_plot) && file.exists(params$assessment_plot))) {
#  knitr::include_graphics(params$assessment_plot, dpi = 900)
#} else {
#  "No visual model assessment plot was generated."
#}
```

\newpage

# Commutability Evaluation Results

This is the final output of the commutability evaluation, based on the data and parameters provided.

## Results Table

The table below shows the detailed numerical results of the commutability evaluation.

```{r ce-results-table}

if (isTRUE(is.list(params$ce_results)) && isTRUE(inherits(params$ce_results$merged_ce_data, "data.table"))) {
  
  ce_results_dt <- params$ce_results$merged_ce_data |> setDT()
  
  ce_results_dt$Zeta <- paste0(
    format(
      x = ce_results_dt$zeta,
      nsmall = 2,
      digits = 2
    ),
    " (",
    format(
      x = ce_results_dt$zeta_ci_lwr,
      nsmall = 2,
      digits = 2
    ),
    " - ",
    format(
      x = ce_results_dt$zeta_ci_upr,
      nsmall = 2,
      digits = 2
    ),
    ")"
  )
  
  ce_results_dt$Zeta_upr <- format(
    x = ce_results_dt$zeta_upper,
    nsmall = 2,
    digits = 2
  )
  
  ce_results_dt$Measurements <- paste0(
    "(",
    format(
      x = ce_results_dt$MP_B,
      nsmall = 2,
      digits = 2
    ),
    ", ",
    format(
      x = ce_results_dt$MP_A,
      nsmall = 2,
      digits = 2
    ),
    ")"
  )
  
  ce_results_dt$Pred <- paste0(
    format(
      x = ce_results_dt$pi_lwr,
      nsmall = 2L,
      digits = 2L
    ),
    " - ",
    format(
      x = ce_results_dt$pi_upr,
      nsmall = 2L,
      digits = 2L
    )
  )
  
  ce_results_dt$Conclusion <- ifelse(
    ce_results_dt$pi_inside == 1L & ce_results_dt$dins_conclusion == 0L,
    "Commutable",
    ifelse(
      ce_results_dt$pi_inside == 0L & ce_results_dt$dins_conclusion == 0L,
      "Noncommutable",
      "Excessive DINS"
    )
  )
  
  ce_results_dt$Strength <- ifelse(
    ce_results_dt$pi_inside == 1L & ce_results_dt$dins_conclusion == 0L,
    paste0(
      "$",
      format(ce_results_dt$pi_inside * 100, nsmall = 1, digits = 1),
      " \\%$"
    ),
    ifelse(
      ce_results_dt$pi_inside == 0L & ce_results_dt$dins_conclusion == 0L,
      paste0(
        "$",
        format((1 - ce_results_dt$pi_inside) * 100, nsmall = 1, digits = 1),
        " \\%$"
      ),
      "."
    )
  )
  
  ce_results_display_dt <- subset(
    x = ce_results_dt,
    select = c(
      "SampleID",
      "Zeta",
      "Zeta_upr",
      "Measurements",
      "Pred",
      "Conclusion",
      "Strength"
    )
  )
  
  # Render Table
  kbl(
    x = ce_results_display_dt,
    format = "latex",
    col.names = c(
      "ID",
      "$\\hat{\\zeta}$",
      "$\\hat{\\zeta}_{\\mathrm{crit}}$",
      "(x, y)",
      "PI",
      "Conclusion",
      "Strength"
    ),
    align = "lcccccc",
    booktabs = TRUE,
    caption = "Commutability Evaluation Results",
    longtable = TRUE,
    position = "H",
    escape = FALSE
  ) |>
    row_spec(
      row = 0,
      bold = TRUE,
      color = "white",
      background = "#605ca8"
    ) |>
    pack_rows(
      index = table(ce_results_dt$comparison),
      bold = TRUE
    ) |>
    column_spec(
      column = 6,
      bold = TRUE,
      color = ifelse(
        ce_results_dt$Conclusion == "Commutable",
        "#28A745",
        ifelse(
          ce_results_dt$Conclusion == "Noncommutable",
          "#dc3545",
          "orange"
        )
      )
    ) |>
    kable_styling(
      latex_options = c(
        "striped",
        "repeat_header"
      )
    )
}

```

## Results Plot

The plot below provides a graphical representation of the commutability evaluation.

```{r ce-results-plot, fig.width = 12, fig.height = 10, out.width = "80%", fig.cap = "Commutability Evaluation Plot"}

if (isTRUE(inherits(params$ce_plot, "ggplot"))) {
  plot(params$ce_plot)
}


```


